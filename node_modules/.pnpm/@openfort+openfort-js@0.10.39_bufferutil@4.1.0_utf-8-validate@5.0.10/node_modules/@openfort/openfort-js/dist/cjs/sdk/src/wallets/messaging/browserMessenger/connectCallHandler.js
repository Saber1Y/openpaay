"use strict";var e=require("./errorSerialization.js"),r=require("./guards.js"),a=require("./methodSerialization.js"),t=require("./namespace.js"),s=require("./PenpalError.js"),n=require("./Reply.js");const o=(r,a,s)=>({namespace:t,channel:r,type:"REPLY",callId:a,isError:!0,...s instanceof Error?{value:e.serializeError(s),isSerializedErrorInstance:!0}:{value:s}});module.exports=(e,i,l,d)=>{let h=!1;const c=async c=>{if(h)return;if(!r.isCallMessage(c))return;d?.(`Received ${a.formatMethodPath(c.methodPath)}() call`,c);const{methodPath:u,args:m,id:M}=c;let f,g;try{const e=a.getMethodAtMethodPath(u,i);if(!e)throw new s("METHOD_NOT_FOUND",`Method \`${a.formatMethodPath(u)}\` is not found.`);let r=await e(...m);r instanceof n&&(g=r.transferables,r=await r.value),f={namespace:t,channel:l,type:"REPLY",callId:M,value:r}}catch(e){f=o(l,M,e)}if(!h)try{d?.(`Sending ${a.formatMethodPath(u)}() reply`,f),e.sendMessage(f,g)}catch(r){throw"DataCloneError"===r.name&&(f=o(l,M,r),d?.(`Sending ${a.formatMethodPath(u)}() reply`,f),e.sendMessage(f)),r}};return e.addMessageHandler(c),()=>{h=!0,e.removeMessageHandler(c)}};
