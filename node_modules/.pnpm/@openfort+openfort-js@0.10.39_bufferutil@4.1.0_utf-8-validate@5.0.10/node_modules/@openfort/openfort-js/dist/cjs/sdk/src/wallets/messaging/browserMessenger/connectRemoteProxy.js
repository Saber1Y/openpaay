"use strict";var e=require("../../../utils/crypto.js"),t=require("./CallOptions.js"),r=require("./errorSerialization.js"),a=require("./guards.js"),o=require("./methodSerialization.js"),s=require("./namespace.js"),n=require("./PenpalError.js");const l=new Set(["apply","call","bind"]),i=(e,t,r=[])=>new Proxy(r.length?()=>{}:Object.create(null),{get(a,o){if("then"!==o)return r.length&&l.has(o)?Reflect.get(a,o):i(e,t,[...r,o])},apply:(t,a,o)=>e(r,o)}),d=e=>new n("CONNECTION_DESTROYED",`Method call ${o.formatMethodPath(e)}() failed due to destroyed connection`);module.exports=(l,c,h)=>{let u=!1;const m=new Map,f=e=>{if(!a.isReplyMessage(e))return;const{callId:t,value:s,isError:n,isSerializedErrorInstance:l}=e,i=m.get(t);i&&(m.delete(t),h?.(`Received ${o.formatMethodPath(i.methodPath)}() call`,e),n?i.reject(l?r.deserializeError(s):s):i.resolve(s))};l.addMessageHandler(f);return{remoteProxy:i((r,a)=>{if(u)throw d(r);const i=e.randomUUID(),f=a[a.length-1],g=f instanceof t,{timeout:M,transferables:p}=g?f:{},P=g?a.slice(0,-1):a;return new Promise((e,t)=>{const a=void 0!==M?window.setTimeout(()=>{m.delete(i),t(new n("METHOD_CALL_TIMEOUT",`Method call ${o.formatMethodPath(r)}() timed out after ${M}ms`))},M):void 0;m.set(i,{methodPath:r,resolve:e,reject:t,timeoutId:a});try{const e={namespace:s,channel:c,type:"CALL",id:i,methodPath:r,args:P};h?.(`Sending ${o.formatMethodPath(r)}() call`,e),l.sendMessage(e,p)}catch(e){t(new n("TRANSMISSION_FAILED",e.message))}})},h),destroy:()=>{u=!0,l.removeMessageHandler(f);for(const{methodPath:e,reject:t,timeoutId:r}of m.values())clearTimeout(r),t(d(e));m.clear()}}};
