"use strict";var e=require("./guards.js"),s=require("./namespace.js"),n=require("./once.js"),r=require("./PenpalError.js"),t=require("./shakeHands.js");const o=new WeakSet;module.exports=({messenger:a,methods:i={},timeout:c,channel:d,log:u})=>{if(!a)throw new r("INVALID_ARGUMENT","messenger must be defined");if(o.has(a))throw new r("INVALID_ARGUMENT","A messenger can only be used for a single connection");o.add(a);const g=[a.destroy],h=n(e=>{if(e){const e={namespace:s,channel:d,type:"DESTROY"};try{a.sendMessage(e)}catch(e){}}for(const e of g)e();u?.("Connection destroyed")}),l=s=>e.isMessage(s)&&s.channel===d;return{promise:(async()=>{try{a.initialize({log:u,validateReceivedMessage:l}),a.addMessageHandler(s=>{e.isDestroyMessage(s)&&h(!1)});const{remoteProxy:s,destroy:n}=await t({messenger:a,methods:i,timeout:c,channel:d,log:u});return g.push(n),s}catch(e){throw h(!0),e}})(),destroy:()=>{h(!0)}}};
