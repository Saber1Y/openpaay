"use strict";var e=require("../backwardCompatibility.js"),s=require("../guards.js"),i=require("../PenpalBugError.js"),t=require("../PenpalError.js");module.exports=class{#e;#s;#i;#t;#r;#o=new Set;#a;#n=!1;constructor({remoteWindow:e,allowedOrigins:s}){if(!e)throw new t("INVALID_ARGUMENT","remoteWindow must be defined");this.#e=e,this.#s=s?.length?s:[window.origin]}initialize=({log:e,validateReceivedMessage:s})=>{this.#i=e,this.#t=s,window.addEventListener("message",this.#g)};sendMessage=(t,r)=>{if(s.isSynMessage(t)){const e=this.#d(t);return void this.#e.postMessage(t,{targetOrigin:e,transfer:r})}if(s.isAck1Message(t)||this.#n){const s=this.#n?e.downgradeMessage(t):t,i=this.#d(t);return void this.#e.postMessage(s,{targetOrigin:i,transfer:r})}if(s.isAck2Message(t)){const{port1:e,port2:s}=new MessageChannel;this.#a=e,e.addEventListener("message",this.#l),e.start();const i=[s,...r||[]],o=this.#d(t);return void this.#e.postMessage(t,{targetOrigin:o,transfer:i})}if(!this.#a)throw new i("Port is undefined");this.#a.postMessage(t,{transfer:r})};addMessageHandler=e=>{this.#o.add(e)};removeMessageHandler=e=>{this.#o.delete(e)};destroy=()=>{window.removeEventListener("message",this.#g),this.#h(),this.#o.clear()};#c=e=>this.#s.some(s=>s instanceof RegExp?s.test(e):s===e||"*"===s);#d=e=>{if(s.isSynMessage(e))return"*";if(!this.#r)throw new i("Concrete remote origin not set");return"null"===this.#r&&this.#s.includes("*")?"*":this.#r};#h=()=>{this.#a?.removeEventListener("message",this.#l),this.#a?.close(),this.#a=void 0};#g=({source:t,origin:r,ports:o,data:a})=>{if(t===this.#e&&(e.isDeprecatedMessage(a)&&(this.#i?.("Please upgrade the child window to the latest version of Penpal."),this.#n=!0,a=e.upgradeMessage(a)),this.#t?.(a)))if(this.#c(r)){if(s.isSynMessage(a)&&(this.#h(),this.#r=r),s.isAck2Message(a)&&!this.#n){if([this.#a]=o,!this.#a)throw new i("No port received on ACK2");this.#a.addEventListener("message",this.#l),this.#a.start()}for(const e of this.#o)e(a)}else this.#i?.(`Received a message from origin \`${r}\` which did not match allowed origins \`[${this.#s.join(", ")}]\``)};#l=({data:e})=>{if(this.#t?.(e))for(const s of this.#o)s(e)}};
