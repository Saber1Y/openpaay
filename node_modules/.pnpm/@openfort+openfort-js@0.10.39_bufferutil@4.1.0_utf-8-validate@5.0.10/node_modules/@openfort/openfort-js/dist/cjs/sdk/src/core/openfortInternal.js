"use strict";var t=require("../utils/debug.js"),e=require("../utils/promiseUtils.js"),r=require("../types/types.js"),n=require("./config/config.js"),o=require("./configuration/authentication.js"),i=require("./errors/openfortError.js");exports.OpenfortInternal=class{storage;authManager;eventEmitter;constructor(t,e,r){this.storage=t,this.authManager=e,this.eventEmitter=r}async getThirdPartyAuthToken(){const t=n.SDKConfiguration.getInstance();if(!t?.thirdPartyAuth)throw new i.OpenfortError("No third party configuration found",i.OpenfortErrorType.INTERNAL_ERROR);const{getAccessToken:e,provider:a}=t.thirdPartyAuth;if(!e||!a)throw new i.OpenfortError("Third party is not configured. Please configure getAccessToken and thirdPartyAuthProvider in your Openfort instance",i.OpenfortErrorType.INVALID_CONFIGURATION);const s=await e();if(!s)throw new i.OpenfortError("Could not get access token",i.OpenfortErrorType.AUTHENTICATION_ERROR);let h=(await o.Authentication.fromStorage(this.storage))?.player;if(!h){const t=await this.authManager.authenticateThirdParty(a,s,r.TokenType.ID_TOKEN);h=t?.id}return new o.Authentication("third_party",s,h,null,a,r.TokenType.ID_TOKEN).save(this.storage),s}async getAccessToken(){if(n.SDKConfiguration.getInstance()?.thirdPartyAuth)return this.getThirdPartyAuthToken();return(await o.Authentication.fromStorage(this.storage))?.token??null}async validateAndRefreshToken(a){return e.singlePromise(async()=>{if(n.SDKConfiguration.getInstance()?.thirdPartyAuth)return void await this.getThirdPartyAuthToken();const e=await o.Authentication.fromStorage(this.storage);if(!e)throw new i.OpenfortError("Must be logged in to validate and refresh token",i.OpenfortErrorType.NOT_LOGGED_IN_ERROR);let s;t.debugLog("validating credentials...");try{s=await this.authManager.validateCredentials(e,a)}catch(t){throw o.Authentication.clear(this.storage),this.eventEmitter.emit(r.OpenfortEvents.ON_LOGOUT),t}if(!s.player)throw new i.OpenfortError("No user found in credentials",i.OpenfortErrorType.INTERNAL_ERROR);s.accessToken!==e.token&&(t.debugLog("tokens refreshed"),new o.Authentication("jwt",s.accessToken,s.player,s.refreshToken).save(this.storage))},"openfort.validateAndRefreshToken")}};
