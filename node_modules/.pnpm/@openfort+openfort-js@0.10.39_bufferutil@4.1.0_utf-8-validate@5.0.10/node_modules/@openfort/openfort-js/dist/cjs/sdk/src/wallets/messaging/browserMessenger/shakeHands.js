"use strict";var e=require("../../../utils/crypto.js"),s=require("./backwardCompatibility.js"),r=require("./connectCallHandler.js"),t=require("./connectRemoteProxy.js"),a=require("./getPromiseWithResolvers.js"),n=require("./guards.js"),o=require("./methodSerialization.js"),i=require("./namespace.js"),c=require("./PenpalError.js");module.exports=({messenger:d,methods:h,timeout:m,channel:u,log:A})=>{const p=e.randomUUID();let I;const l=[];let g=!1;const P=o.extractMethodPathsFromMethods(h),{promise:S,resolve:N,reject:C}=a(),y=setTimeout(()=>{C(new c("CONNECTION_TIMEOUT",`Connection timed out after ${m}ms`))},m),E=()=>{for(const e of l)e()},M=()=>{if(g)return;l.push(r(d,h,u,A));const{remoteProxy:e,destroy:s}=t(d,u,A);l.push(s),clearTimeout(y),g=!0,N({remoteProxy:e,destroy:E})},T=()=>{const e={namespace:i,type:"SYN",channel:u,participantId:p};A?.("Sending handshake SYN",e);try{d.sendMessage(e)}catch(e){C(new c("TRANSMISSION_FAILED",e.message))}},R=e=>{n.isSynMessage(e)&&(e=>{if(A?.("Received handshake SYN",e),e.participantId===I&&I!==s.DEPRECATED_PENPAL_PARTICIPANT_ID)return;if(I=e.participantId,T(),!(p>I||I===s.DEPRECATED_PENPAL_PARTICIPANT_ID))return;const r={namespace:i,channel:u,type:"ACK1",methodPaths:P};A?.("Sending handshake ACK1",r);try{d.sendMessage(r)}catch(e){C(new c("TRANSMISSION_FAILED",e.message))}})(e),n.isAck1Message(e)&&(e=>{A?.("Received handshake ACK1",e);const s={namespace:i,channel:u,type:"ACK2"};A?.("Sending handshake ACK2",s);try{d.sendMessage(s)}catch(e){return void C(new c("TRANSMISSION_FAILED",e.message))}M()})(e),n.isAck2Message(e)&&(e=>{A?.("Received handshake ACK2",e),M()})(e)};return d.addMessageHandler(R),l.push(()=>d.removeMessageHandler(R)),T(),S};
