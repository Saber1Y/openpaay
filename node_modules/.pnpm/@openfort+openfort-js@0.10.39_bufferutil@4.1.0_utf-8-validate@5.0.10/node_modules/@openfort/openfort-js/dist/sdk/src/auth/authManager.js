import{base64url as e,decodeJwt as t}from"jose";import{debugLog as a}from"../utils/debug.js";import{OpenfortError as i,OpenfortErrorType as n,withOpenfortError as s}from"../core/errors/openfortError.js";import{sentry as r}from"../core/errors/sentry.js";import{StorageKeys as o}from"../storage/istorage.js";import{CodeChallengeMethodEnum as c}from"../types/types.js";import{cryptoDigest as d}from"../utils/crypto.js";async function l(e){const t=(new TextEncoder).encode(e),a=await d("SHA-256",t);return new Uint8Array(a)}function u(e){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}class h{decodedPayload;value;constructor(e){this.value=e;try{this.decodedPayload=t(e)}catch(e){throw new i("Invalid token format",n.AUTHENTICATION_ERROR)}}get subject(){return this.decodedPayload.sub}get expiration(){return this.decodedPayload.exp}get issuer(){return this.decodedPayload.iss}isExpired(e=30){return!this.expiration||(a("Token expiration:",1e3*(this.expiration-e),"Current time:",Date.now()),Date.now()>=1e3*(this.expiration-e))}static parse(e){try{return new h(e)}catch{return null}}}class p{storage;constructor(e){this.storage=e}async savePKCEData(e){this.storage.save(o.PKCE_STATE,e.state),this.storage.save(o.PKCE_VERIFIER,e.verifier)}async getPKCEData(){const e=await this.storage.get(o.PKCE_STATE),t=await this.storage.get(o.PKCE_VERIFIER);return e&&t?{state:e,verifier:t}:null}async clearPKCEData(){this.storage.remove(o.PKCE_STATE),this.storage.remove(o.PKCE_VERIFIER)}}class E{deviceCredentialsManager;backendApiClientsInstance;publishableKeyInstance;constructor(e){this.deviceCredentialsManager=new p(e)}setBackendApiClients(e,t){this.backendApiClientsInstance=e,this.publishableKeyInstance=t}get backendApiClients(){if(!this.backendApiClientsInstance)throw new i("Backend API clients not initialized",n.INTERNAL_ERROR);return this.backendApiClientsInstance}get publishableKey(){if(!this.publishableKeyInstance)throw new i("Publishable key not initialized",n.INTERNAL_ERROR);return this.publishableKeyInstance}async initOAuth(e,t,a){const i=t?.usePooling??!1,r=t?.skipBrowserRedirect??!1,{usePooling:o,skipBrowserRedirect:c,...d}=t||{},l={oAuthInitRequest:{provider:e,options:d,usePooling:i}},u=await s(async()=>this.backendApiClients.authenticationApi.initOAuth(l,E.getEcosystemGameOptsOrUndefined(a)),{default:n.AUTHENTICATION_ERROR});return"undefined"==typeof window||r||window.location.assign(u.data.url),{url:u.data.url,key:u.data.key}}async registerGuest(){const e={};return s(async()=>(await this.backendApiClients.authenticationApi.registerGuest(e)).data,{default:n.USER_REGISTRATION_ERROR})}async poolOAuth(e){const t={key:e};for(let e=0;e<600;e++)try{const e=await s(async()=>this.backendApiClients.authenticationApi.poolOAuth(t),{default:n.AUTHENTICATION_ERROR});if(200===e.status)return e.data}catch(e){if(e.response&&404===e.response.status){await new Promise(e=>{setTimeout(e,500)});continue}throw e}throw new Error("Failed to pool OAuth, try again later")}async loginWithIdToken(e,t,a){const i={loginWithIdTokenRequest:{provider:e,token:t}};return s(async()=>(await this.backendApiClients.authenticationApi.loginWithIdToken(i,E.getEcosystemGameOptsOrUndefined(a))).data,{default:n.AUTHENTICATION_ERROR,401:n.AUTHENTICATION_ERROR,403:n.USER_NOT_AUTHORIZED_ON_ECOSYSTEM},e=>{r.captureAxiosError("loginWithIdToken",e)})}async authenticateThirdParty(e,t,a,i){const o={thirdPartyOAuthRequest:{provider:e,token:t,tokenType:a}};return s(async()=>(await this.backendApiClients.authenticationApi.thirdParty(o,E.getEcosystemGameOptsOrUndefined(i))).data,{default:n.AUTHENTICATION_ERROR,401:n.AUTHENTICATION_ERROR,403:n.USER_NOT_AUTHORIZED_ON_ECOSYSTEM},e=>{r.captureAxiosError("authenticateThirdParty",e)})}async initSIWE(e,t){const a={sIWERequest:{address:e}},i=await s(async()=>this.backendApiClients.authenticationApi.initSIWE(a,E.getEcosystemGameOptsOrUndefined(t)),{default:n.AUTHENTICATION_ERROR});return{address:i.data.address,nonce:i.data.nonce,expiresAt:i.data.expiresAt}}async authenticateSIWE(e,t,a,i){const o={sIWEAuthenticateRequest:{signature:e,message:t,walletClientType:a,connectorType:i}};return s(async()=>(await this.backendApiClients.authenticationApi.authenticateSIWE(o)).data,{default:n.AUTHENTICATION_ERROR,401:n.AUTHENTICATION_ERROR,403:n.USER_NOT_AUTHORIZED_ON_ECOSYSTEM},e=>{r.captureAxiosError("authenticateSIWE",e)})}static getEcosystemGameOptsOrUndefined(e){if(e)return{headers:{"x-game":e}}}async loginEmailPassword(e,t,a){const i={loginRequest:{email:e,password:t}};return s(async()=>(await this.backendApiClients.authenticationApi.loginEmailPassword(i,E.getEcosystemGameOptsOrUndefined(a))).data,{default:n.AUTHENTICATION_ERROR,401:n.AUTHENTICATION_ERROR,403:n.USER_NOT_AUTHORIZED_ON_ECOSYSTEM},e=>{r.captureAxiosError("loginEmailPassword",e)})}async requestResetPassword(t,a){const i=u(32),r=e.encode(i),o=await l(r),d=e.encode(o),h=u(32),p=e.encode(h);await this.deviceCredentialsManager.savePKCEData({state:p,verifier:r});const E={requestResetPasswordRequest:{email:t,redirectUrl:a,challenge:{codeChallenge:d,method:c.S256}}};await s(async()=>{await this.backendApiClients.authenticationApi.requestResetPassword(E)},{default:n.AUTHENTICATION_ERROR})}async resetPassword(e,t,a){return s(async()=>{const i=await this.deviceCredentialsManager.getPKCEData();if(!i)throw new Error("No code verifier or state for PKCE");const n={resetPasswordRequest:{email:e,password:t,state:a,challenge:{codeVerifier:i.verifier}}};await this.backendApiClients.authenticationApi.resetPassword(n)},{default:n.AUTHENTICATION_ERROR})}async requestEmailVerification(t,a){const i=u(32),r=e.encode(i),o=await l(r),d=e.encode(o),h=u(32),p=e.encode(h);await this.deviceCredentialsManager.savePKCEData({state:p,verifier:r});const E={requestVerifyEmailRequest:{email:t,redirectUrl:a,challenge:{codeChallenge:d,method:c.S256}}};await s(async()=>{await this.backendApiClients.authenticationApi.requestEmailVerification(E)},{default:n.AUTHENTICATION_ERROR})}async verifyEmail(e,t){return s(async()=>{const a=await this.deviceCredentialsManager.getPKCEData();if(!a)throw new Error("No code verifier or state for PKCE");const i={verifyEmailRequest:{email:e,token:t,challenge:{codeVerifier:a.verifier}}};await this.backendApiClients.authenticationApi.verifyEmail(i)},{default:n.AUTHENTICATION_ERROR})}async signupEmailPassword(e,t,a,i){const o={signupRequest:{email:e,password:t,name:a}};return s(async()=>(await this.backendApiClients.authenticationApi.signupEmailPassword(o,E.getEcosystemGameOptsOrUndefined(i))).data,{default:n.USER_REGISTRATION_ERROR,401:n.USER_REGISTRATION_ERROR,403:n.USER_NOT_AUTHORIZED_ON_ECOSYSTEM},e=>{r.captureAxiosError("signupEmailPassword",e)})}async validateCredentials(e,t){if(!e.refreshToken)throw new i("No refresh token provided",n.AUTHENTICATION_ERROR);if(t)return this.refreshTokens(e.refreshToken,t);a("Validating credentials with token:",e.token);const s=h.parse(e.token);return s?s.isExpired()?(a("Token expired, refreshing..."),this.refreshTokens(e.refreshToken)):{player:s.subject,accessToken:e.token,refreshToken:e.refreshToken}:this.refreshTokens(e.refreshToken)}async refreshTokens(e,t){const a={refreshTokenRequest:{refreshToken:e,forceRefresh:t}};return s(async()=>{const e=await this.backendApiClients.authenticationApi.refresh(a);return{player:e.data.player.id,accessToken:e.data.token,refreshToken:e.data.refreshToken}},{default:n.REFRESH_TOKEN_ERROR})}async logout(e,t){const a={logoutRequest:{refreshToken:t}};return s(async()=>{await this.backendApiClients.authenticationApi.logout(a,{headers:{authorization:`Bearer ${this.publishableKey}`,"x-player-token":e}})},{default:n.LOGOUT_ERROR})}async getUser(e){return s(async()=>(await this.backendApiClients.authenticationApi.me({headers:{authorization:`Bearer ${this.publishableKey}`,"x-player-token":e.token,"x-auth-provider":e.thirdPartyProvider,"x-token-type":e.thirdPartyTokenType}})).data,{default:n.AUTHENTICATION_ERROR})}async linkThirdParty(e,t,a,i,r){const o={thirdPartyLinkRequest:{provider:t,token:a,tokenType:i}};return s(async()=>(await this.backendApiClients.authenticationApi.linkThirdParty(o,{headers:{authorization:`Bearer ${this.publishableKey}`,"x-player-token":e.token,"x-auth-provider":e.thirdPartyProvider||void 0,"x-token-type":e.thirdPartyTokenType||void 0,"x-game":r||void 0}})).data,{default:n.AUTHENTICATION_ERROR})}async linkOAuth(e,t,a,i){const r=a?.skipBrowserRedirect??!1;delete a?.skipBrowserRedirect;const o={oAuthInitRequest:{provider:t,options:a,usePooling:a?.usePooling||!1}},c=await s(async()=>this.backendApiClients.authenticationApi.linkOAuth(o,{headers:{authorization:`Bearer ${this.publishableKey}`,"x-player-token":e.token,"x-auth-provider":e.thirdPartyProvider||void 0,"x-token-type":e.thirdPartyTokenType||void 0,"x-game":i||void 0}}),{default:n.AUTHENTICATION_ERROR});return"undefined"==typeof window||r||window.location.assign(c.data.url),{url:c.data.url,key:c.data.key}}async unlinkOAuth(e,t){const a={unlinkOAuthRequest:{provider:e}};return s(async()=>(await this.backendApiClients.authenticationApi.unlinkOAuth(a,{headers:{authorization:`Bearer ${this.publishableKey}`,"x-player-token":t}})).data,{default:n.AUTHENTICATION_ERROR})}async unlinkWallet(e,t){const a={sIWERequest:{address:e}};return s(async()=>(await this.backendApiClients.authenticationApi.unlinkSIWE(a,{headers:{authorization:`Bearer ${this.publishableKey}`,"x-player-token":t}})).data,{default:n.AUTHENTICATION_ERROR})}async linkWallet(e,t,a,i,r){const o={sIWEAuthenticateRequest:{signature:e,message:t,walletClientType:a,connectorType:i}};return s(async()=>(await this.backendApiClients.authenticationApi.linkSIWE(o,{headers:{authorization:`Bearer ${this.publishableKey}`,"x-player-token":r}})).data,{default:n.AUTHENTICATION_ERROR})}async unlinkEmail(e,t){const a={unlinkEmailRequest:{email:e}};return s(async()=>(await this.backendApiClients.authenticationApi.unlinkEmail(a,{headers:{authorization:`Bearer ${this.publishableKey}`,"x-player-token":t}})).data,{default:n.AUTHENTICATION_ERROR})}async linkEmail(e,t,a,i){const r={loginRequest:{email:e,password:t}};return s(async()=>(await this.backendApiClients.authenticationApi.linkEmail(r,{headers:{authorization:`Bearer ${this.publishableKey}`,"x-player-token":a,"x-game":i||void 0}})).data,{default:n.AUTHENTICATION_ERROR})}}export{E as AuthManager};
