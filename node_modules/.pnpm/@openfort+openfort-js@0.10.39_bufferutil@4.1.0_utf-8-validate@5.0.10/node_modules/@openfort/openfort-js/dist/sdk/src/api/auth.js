import{Authentication as t}from"../core/configuration/authentication.js";import{OpenfortError as e,OpenfortErrorType as a}from"../core/errors/openfortError.js";import{OpenfortEvents as i}from"../types/types.js";class r{storage;authManager;validateAndRefreshToken;ensureInitialized;eventEmitter;constructor(t,e,a,i,r){this.storage=t,this.authManager=e,this.validateAndRefreshToken=a,this.ensureInitialized=i,this.eventEmitter=r}async logInWithEmailPassword({email:r,password:s,ecosystemGame:n}){await this.ensureInitialized();if(await t.fromStorage(this.storage))throw new e("Already logged in",a.ALREADY_LOGGED_IN_ERROR);this.eventEmitter.emit(i.ON_AUTH_INIT,{method:"email",provider:"email"});try{const e=await this.authManager.loginEmailPassword(r,s,n);return"action"in e||(new t("jwt",e.token,e.player.id,e.refreshToken).save(this.storage),this.eventEmitter.emit(i.ON_AUTH_SUCCESS,e)),e}catch(t){throw this.eventEmitter.emit(i.ON_AUTH_FAILURE,t),t}}async signUpGuest(){await this.ensureInitialized();if(await t.fromStorage(this.storage))throw new e("Already logged in",a.ALREADY_LOGGED_IN_ERROR);this.eventEmitter.emit(i.ON_AUTH_INIT,{method:"guest"});try{const e=await this.authManager.registerGuest();return new t("jwt",e.token,e.player.id,e.refreshToken).save(this.storage),this.eventEmitter.emit(i.ON_AUTH_SUCCESS,e),e}catch(t){throw this.eventEmitter.emit(i.ON_AUTH_FAILURE,t),t}}async signUpWithEmailPassword({email:r,password:s,options:n,ecosystemGame:o}){await this.ensureInitialized();if(await t.fromStorage(this.storage))throw new e("Already logged in",a.ALREADY_LOGGED_IN_ERROR);this.eventEmitter.emit(i.ON_AUTH_INIT,{method:"email",provider:"email"});try{const e=await this.authManager.signupEmailPassword(r,s,n?.data.name,o);return"action"in e||(new t("jwt",e.token,e.player.id,e.refreshToken).save(this.storage),this.eventEmitter.emit(i.ON_AUTH_SUCCESS,e)),e}catch(t){throw this.eventEmitter.emit(i.ON_AUTH_FAILURE,t),t}}async linkEmailPassword({email:t,password:e,authToken:a,ecosystemGame:i}){return await this.validateAndRefreshToken(),await this.authManager.linkEmail(t,e,a,i)}async unlinkEmailPassword({email:t,authToken:e}){return await this.validateAndRefreshToken(),await this.authManager.unlinkEmail(t,e)}async requestEmailVerification({email:t,redirectUrl:e}){await this.ensureInitialized(),await this.authManager.requestEmailVerification(t,e)}async resetPassword({email:t,password:e,state:a}){await this.ensureInitialized(),await this.authManager.resetPassword(t,e,a)}async requestResetPassword({email:t,redirectUrl:e}){await this.ensureInitialized(),await this.authManager.requestResetPassword(t,e)}async verifyEmail({email:t,state:e}){await this.ensureInitialized(),await this.authManager.verifyEmail(t,e)}async initOAuth({provider:r,options:s,ecosystemGame:n}){await this.ensureInitialized();if(await t.fromStorage(this.storage))throw new e("Already logged in",a.ALREADY_LOGGED_IN_ERROR);return this.eventEmitter.emit(i.ON_AUTH_INIT,{method:"oauth",provider:r}),await this.authManager.initOAuth(r,s,n)}async initLinkOAuth({provider:r,options:s,ecosystemGame:n}){await this.validateAndRefreshToken();const o=await t.fromStorage(this.storage);if(!o)throw new e("No authentication found",a.NOT_LOGGED_IN_ERROR);return this.eventEmitter.emit(i.ON_AUTH_INIT,{method:"oauth",provider:r}),await this.authManager.linkOAuth(o,r,s,n)}async unlinkOAuth({provider:t,authToken:e}){return await this.validateAndRefreshToken(),await this.authManager.unlinkOAuth(t,e)}async poolOAuth(e){await this.ensureInitialized();try{const a=await this.authManager.poolOAuth(e);return new t("jwt",a.token,a.player.id,a.refreshToken).save(this.storage),this.eventEmitter.emit(i.ON_AUTH_SUCCESS,a),a}catch(t){throw this.eventEmitter.emit(i.ON_AUTH_FAILURE,t),t}}async loginWithIdToken({provider:r,token:s,ecosystemGame:n}){await this.ensureInitialized();if(await t.fromStorage(this.storage))throw new e("Already logged in",a.ALREADY_LOGGED_IN_ERROR);this.eventEmitter.emit(i.ON_AUTH_INIT,{method:"idToken",provider:r});try{const e=await this.authManager.loginWithIdToken(r,s,n);return new t("jwt",e.token,e.player.id,e.refreshToken).save(this.storage),this.eventEmitter.emit(i.ON_AUTH_SUCCESS,e),e}catch(t){throw this.eventEmitter.emit(i.ON_AUTH_FAILURE,t),t}}async initSIWE({address:t,ecosystemGame:e}){return await this.ensureInitialized(),await this.authManager.initSIWE(t,e)}async authenticateWithSIWE({signature:r,message:s,walletClientType:n,connectorType:o}){await this.ensureInitialized();if(await t.fromStorage(this.storage))throw new e("Already logged in",a.ALREADY_LOGGED_IN_ERROR);this.eventEmitter.emit(i.ON_AUTH_INIT,{method:"siwe",provider:"wallet"});try{const e=await this.authManager.authenticateSIWE(r,s,n,o);return new t("jwt",e.token,e.player.id,e.refreshToken).save(this.storage),this.eventEmitter.emit(i.ON_AUTH_SUCCESS,e),e}catch(t){throw this.eventEmitter.emit(i.ON_AUTH_FAILURE,t),t}}async linkWallet({signature:t,message:e,walletClientType:a,connectorType:i,authToken:r}){return await this.validateAndRefreshToken(),await this.authManager.linkWallet(t,e,a,i,r)}async unlinkWallet({address:t,authToken:e}){return await this.validateAndRefreshToken(),await this.authManager.unlinkWallet(t,e)}async storeCredentials(i){if(await this.ensureInitialized(),!i.player)throw new e("Player ID is required to store credentials",a.INVALID_CONFIGURATION);new t("jwt",i.accessToken,i.player,i.refreshToken).save(this.storage)}async logout(){const e=await t.fromStorage(this.storage);if(e){try{"third_party"!==e.type&&await this.authManager.logout(e.token,e.refreshToken??"")}catch(t){}t.clear(this.storage),this.eventEmitter.emit(i.ON_LOGOUT)}}}export{r as AuthApi};
