import{Account as e}from"../core/configuration/account.js";import{Authentication as i}from"../core/configuration/authentication.js";import{OpenfortError as t,OpenfortErrorType as n}from"../core/errors/openfortError.js";import{sentry as r}from"../core/errors/sentry.js";import{StorageKeys as o}from"../storage/istorage.js";import{randomUUID as s}from"../utils/crypto.js";import{debugLog as a}from"../utils/debug.js";import{ReactNativeMessenger as d}from"./messaging/ReactNativeMessenger.js";import c from"./messaging/browserMessenger/connect.js";import"./messaging/browserMessenger/backwardCompatibility.js";import{isErrorResponse as h,NOT_CONFIGURED_ERROR as u,MISSING_USER_ENTROPY_ERROR as l,MISSING_PROJECT_ENTROPY_ERROR as y,INCORRECT_USER_ENTROPY_ERROR as f,MISSING_PASSKEY_ERROR as g,INCORRECT_PASSKEY_ERROR as p,OTP_REQUIRED_ERROR as m,ShieldAuthType as w,Event as C,SignRequest as v,SwitchChainRequest as I,ExportPrivateKeyRequest as k,SetRecoveryMethodRequest as P,GetCurrentDeviceRequest as E,UpdateAuthenticationRequest as R}from"./types.js";class T extends Error{constructor(){super("This embedded signer requires a password to be recovered")}}class b extends Error{constructor(){super("Wrong recovery passkey for this embedded signer")}}class N extends Error{constructor(){super("MissingProjectEntropyError")}}class A extends Error{constructor(){super("Wrong recovery password for this embedded signer")}}class S extends Error{constructor(){super("Not configured")}}class U extends Error{constructor(){super("OTP required")}}class O{messenger;connection;remote;storage;sdkConfiguration;isInitialized=!1;initializationPromise=null;hasFailed=!1;constructor(e,i,r){if(!e)throw new t("Configuration is required for IframeManager",n.INVALID_CONFIGURATION);if(!i)throw new t("Storage is required for IframeManager",n.INVALID_CONFIGURATION);if(!r)throw new t("Messenger is required for IframeManager",n.INVALID_CONFIGURATION);this.sdkConfiguration=e,this.storage=i,this.messenger=r}async initialize(){if(!this.isInitialized){if(this.hasFailed)throw new t("Failed to establish iFrame connection: Previous connection attempt failed",n.INTERNAL_ERROR);if(this.initializationPromise)await this.initializationPromise;else{this.initializationPromise=this.doInitialize();try{await this.initializationPromise,this.isInitialized=!0}catch(e){throw this.hasFailed=!0,this.initializationPromise=null,e}}}}async doInitialize(){a("Initializing IframeManager connection..."),this.messenger.initialize({validateReceivedMessage:e=>!(!e||"object"!=typeof e),log:a}),this.connection=c({messenger:this.messenger,timeout:1e4,log:a});try{this.remote=await this.connection.promise,a("IframeManager connection established")}catch(e){const i=e;throw r.captureException(i),this.destroy(),a("Failed to establish connection:",i),new t(`Failed to establish iFrame connection: ${i.cause||i.message}`,n.INTERNAL_ERROR,e)}}async ensureConnection(){if(this.isInitialized&&this.remote||await this.initialize(),!this.remote)throw new t("Failed to establish connection",n.INTERNAL_ERROR);return this.remote}handleError(e){if(h(e)){if(e.error===u)throw this.storage.remove(o.ACCOUNT),new S;if(e.error===l)throw this.storage.remove(o.ACCOUNT),new T;if(e.error===y)throw this.storage.remove(o.ACCOUNT),new N;if(e.error===f)throw new A;if(e.error===g)throw this.storage.remove(o.ACCOUNT),new T;if(e.error===p)throw new b;if(e.error===m)throw new U;throw this.storage.remove(o.ACCOUNT),new t(`Unknown error: ${e.error}`,n.INTERNAL_ERROR)}throw e}async buildRequestConfiguration(){const e=await i.fromStorage(this.storage);if(!e)throw new t("Must be authenticated to create a signer",n.NOT_LOGGED_IN_ERROR);const r={auth:w.OPENFORT,authProvider:e.thirdPartyProvider,token:e.token,tokenType:e.thirdPartyTokenType};return{thirdPartyProvider:e.thirdPartyProvider,thirdPartyTokenType:e.thirdPartyTokenType,token:e.token,publishableKey:this.sdkConfiguration.baseConfiguration.publishableKey,openfortURL:this.sdkConfiguration.backendUrl,shieldAuthentication:r,shieldAPIKey:this.sdkConfiguration.shieldConfiguration?.shieldPublishableKey||"",shieldURL:this.sdkConfiguration.shieldUrl,encryptionKey:this.sdkConfiguration?.shieldConfiguration?.shieldEncryptionKey??void 0,appNativeIdentifier:this.sdkConfiguration?.nativeAppIdentifier??void 0}}async buildIFrameRequestConfiguration(){const e=await i.fromStorage(this.storage);if(!e)throw new t("Must be authenticated to create a signer",n.NOT_LOGGED_IN_ERROR);const r={auth:w.OPENFORT,authProvider:e.thirdPartyProvider,token:e.token,tokenType:e.thirdPartyTokenType};return{thirdPartyTokenType:e.thirdPartyTokenType??null,thirdPartyProvider:e.thirdPartyProvider??null,accessToken:e.token,playerID:e.player,recovery:r,chainId:null,password:null,passkey:null}}async create(e){if(!this.sdkConfiguration.shieldConfiguration)throw new Error("shieldConfiguration is required");const i=await this.ensureConnection(),t=await this.buildIFrameRequestConfiguration();t.chainId=e.chainId??null,t.password=e?.entropy?.recoveryPassword??null,t.recovery={...t.recovery,encryptionSession:e?.entropy?.encryptionSession},t.passkey=e?.entropy?.passkey??null;const n={uuid:s(),action:C.CREATE,recovery:t.recovery,publishableKey:this.sdkConfiguration.baseConfiguration.publishableKey,shieldAPIKey:this.sdkConfiguration.shieldConfiguration?.shieldPublishableKey||"",accessToken:t.accessToken,playerID:t.playerID,thirdPartyProvider:t.thirdPartyProvider,thirdPartyTokenType:t.thirdPartyTokenType,encryptionKey:t.password,encryptionSession:t.recovery?.encryptionSession??null,passkey:t.passkey??null,openfortURL:this.sdkConfiguration.backendUrl,shieldURL:this.sdkConfiguration.shieldUrl,chainId:e.chainId??null,accountType:e.accountType,chainType:e.chainType,nativeAppIdentifier:this.sdkConfiguration?.nativeAppIdentifier??null},r=await i.create(n);return h(r)&&this.handleError(r),"undefined"!=typeof sessionStorage&&sessionStorage.setItem("iframe-version",r.version??"undefined"),r}async recover(i){if(!this.sdkConfiguration.shieldConfiguration)throw new Error("shieldConfiguration is required");const t=await e.fromStorage(this.storage),n=await this.ensureConnection(),r=await this.buildIFrameRequestConfiguration();r.chainId=t?.chainId??null,r.password=i?.entropy?.recoveryPassword??null,r.recovery={...r.recovery,encryptionSession:i?.entropy?.encryptionSession},r.passkey=i?.entropy?.passkey??null;const o={uuid:s(),action:C.RECOVER,recovery:r.recovery,publishableKey:this.sdkConfiguration.baseConfiguration.publishableKey,shieldAPIKey:this.sdkConfiguration.shieldConfiguration?.shieldPublishableKey||"",accessToken:r.accessToken,playerID:r.playerID,thirdPartyProvider:r.thirdPartyProvider,thirdPartyTokenType:r.thirdPartyTokenType,encryptionKey:r.password,encryptionSession:r.recovery?.encryptionSession??null,passkey:r.passkey??null,openfortURL:this.sdkConfiguration.backendUrl,shieldURL:this.sdkConfiguration.shieldUrl,account:i.account,nativeAppIdentifier:this.sdkConfiguration?.nativeAppIdentifier??null},a=await n.recover(o);return h(a)&&this.handleError(a),"undefined"!=typeof sessionStorage&&sessionStorage.setItem("iframe-version",a.version??"undefined"),a}async sign(e,i,t,n){a("[iframe] ensureConnection");const r=await this.ensureConnection(),o=new v(s(),e,await this.buildRequestConfiguration(),i,t,n);a("[iframe] done ensureConnection");const d=await r.sign(o);return a("[iframe] response",d),h(d)&&this.handleError(d),"undefined"!=typeof sessionStorage&&sessionStorage.setItem("iframe-version",d.version??"undefined"),d.signature}async switchChain(e){const i=await this.ensureConnection(),t=new I(s(),e,await this.buildRequestConfiguration()),n=await i.switchChain(t);return h(n)&&this.handleError(n),n}async export(){const e=await this.ensureConnection(),i=new k(s(),await this.buildRequestConfiguration()),t=await e.export(i);return h(t)&&this.handleError(t),"undefined"!=typeof sessionStorage&&sessionStorage.setItem("iframe-version",t.version??"undefined"),t.key}async setRecoveryMethod(e,i,t,n,r){const o=await this.ensureConnection(),a=new P(s(),e,await this.buildRequestConfiguration(),i,t,n,r),d=await o.setRecoveryMethod(a);h(d)&&this.handleError(d),"undefined"!=typeof sessionStorage&&sessionStorage.setItem("iframe-version",d.version??"undefined")}async getCurrentDevice(e){const i=await this.ensureConnection(),t=new E(s(),e);try{const e=await i.getCurrentDevice(t);return h(e)&&this.handleError(e),"undefined"!=typeof sessionStorage&&sessionStorage.setItem("iframe-version",e.version??"undefined"),e}catch(e){if(e instanceof S)return null;throw e}}async updateAuthentication(){if(!this.isLoaded()||!this.remote)return void a("IframeManager not loaded, skipping authentication update");const e=await i.fromStorage(this.storage);if(!e)return void a("No authentication found, skipping update");const t=new R(s(),e.token);a("Updating authentication in iframe with token");const n=await this.remote.updateAuthentication(t);h(n)&&this.handleError(n)}async disconnect(){const e=await this.ensureConnection(),i={uuid:s()};await e.logout(i)}async onMessage(e){a("[HANDSHAKE DEBUG] IframeManager.onMessage called with:",e),this.messenger instanceof d?(this.isInitialized||this.connection?a(`[HANDSHAKE DEBUG] Connection already initialized (isInitialized: ${this.isInitialized}, hasConnection: ${!!this.connection})`):(a("[HANDSHAKE DEBUG] First message received, initializing connection..."),this.initialize().catch(e=>{a("[HANDSHAKE DEBUG] Failed to initialize connection:",e)})),a("[HANDSHAKE DEBUG] Passing message to ReactNativeMessenger"),this.messenger.handleMessage(e)):a("[HANDSHAKE DEBUG] Not a ReactNativeMessenger, ignoring message")}isLoaded(){return this.isInitialized&&void 0!==this.remote}destroy(){this.connection&&this.connection.destroy(),this.remote=void 0,this.isInitialized=!1,this.connection=void 0,this.initializationPromise=null}}export{O as IframeManager,N as MissingProjectEntropyError,T as MissingRecoveryPasswordError,S as NotConfiguredError,U as OTPRequiredError,A as WrongRecoveryPasswordError};
