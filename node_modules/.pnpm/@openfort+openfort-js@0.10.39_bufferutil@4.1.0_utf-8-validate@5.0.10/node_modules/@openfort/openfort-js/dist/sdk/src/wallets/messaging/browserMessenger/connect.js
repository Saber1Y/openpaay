import{isMessage as e,isDestroyMessage as s}from"./guards.js";import o from"./namespace.js";import n from"./once.js";import t from"./PenpalError.js";import r from"./shakeHands.js";const a=new WeakSet,m=({messenger:m,methods:c={},timeout:i,channel:d,log:h})=>{if(!m)throw new t("INVALID_ARGUMENT","messenger must be defined");if(a.has(m))throw new t("INVALID_ARGUMENT","A messenger can only be used for a single connection");a.add(m);const l=[m.destroy],f=n(e=>{if(e){const e={namespace:o,channel:d,type:"DESTROY"};try{m.sendMessage(e)}catch(e){}}for(const e of l)e();h?.("Connection destroyed")}),g=s=>e(s)&&s.channel===d;return{promise:(async()=>{try{m.initialize({log:h,validateReceivedMessage:g}),m.addMessageHandler(e=>{s(e)&&f(!1)});const{remoteProxy:e,destroy:o}=await r({messenger:m,methods:c,timeout:i,channel:d,log:h});return l.push(o),e}catch(e){throw f(!0),e}})(),destroy:()=>{f(!0)}}};export{m as default};
