import{debugLog as e}from"../../utils/debug.js";import t from"./browserMessenger/PenpalError.js";import"./browserMessenger/backwardCompatibility.js";class s{messagePoster;handlers=new Set;isInitialized=!1;hasBeenUsed=!1;validateMessage;messageBuffer=[];nextNumericId=1;stringToNumericId=new Map;numericToStringId=new Map;constructor(s){if(this.messagePoster=s,!s||"function"!=typeof s.postMessage)throw new t("CONNECTION_DESTROYED","Invalid message poster provided");e("ReactNativeMessenger created")}initialize(s){if(this.isInitialized)return void e("ReactNativeMessenger already initialized");if(this.hasBeenUsed)throw new t("CONNECTION_DESTROYED","A messenger can only be used for a single connection");this.validateMessage=s?.validateReceivedMessage,this.isInitialized=!0,this.hasBeenUsed=!0,e(`ReactNativeMessenger initialized, processing ${this.messageBuffer.length} buffered messages`);const a=[...this.messageBuffer];this.messageBuffer=[],a.forEach(e=>{this.processMessage(e)})}sendMessage(s,a){if(!this.isInitialized)throw new t("CONNECTION_DESTROYED","ReactNativeMessenger not initialized");a&&a.length>0&&e("React Native: Ignoring transferables (not supported)"),e("ReactNativeMessenger sending message:",s);try{let t=s;"penpal"===s?.namespace&&(t=this.convertToDeprecatedFormat(s),e("React Native: Converted message:",t));const a=JSON.stringify(t);this.messagePoster.postMessage(a)}catch(e){throw new t("TRANSMISSION_FAILED",`Failed to send message through React Native WebView: ${e instanceof Error?e.message:String(e)}`)}}addMessageHandler(t){this.handlers.add(t),e(`Message handler added, total handlers: ${this.handlers.size}`)}removeMessageHandler(t){this.handlers.delete(t),e(`Message handler removed, total handlers: ${this.handlers.size}`)}handleMessage(t){if(e("[HANDSHAKE DEBUG] ReactNativeMessenger.handleMessage called with:",t),!this.isInitialized){const s=this.messageBuffer.length+1;return e(`[HANDSHAKE DEBUG] ReactNativeMessenger: Message received but not initialized, buffering message (${s} total)`),void this.messageBuffer.push(t)}e("[HANDSHAKE DEBUG] ReactNativeMessenger is initialized, processing message"),this.processMessage(t)}processMessage(t){e("[HANDSHAKE DEBUG] ReactNativeMessenger processing message:",t);const s=this.convertFromDeprecatedFormat(t);if(e("[HANDSHAKE DEBUG] Message after conversion:",s),this.validateMessage&&!this.validateMessage(s))return void e("[HANDSHAKE DEBUG] Message validation failed:",s);e(`[HANDSHAKE DEBUG] Routing message to ${this.handlers.size} handlers`);let a=0;this.handlers.forEach(t=>{a++;try{e(`[HANDSHAKE DEBUG] Calling handler ${a}/${this.handlers.size}`),t(s),e(`[HANDSHAKE DEBUG] Handler ${a} completed successfully`)}catch(t){e(`[HANDSHAKE DEBUG] Error in handler ${a}:`,t)}})}convertToDeprecatedFormat(t){if("penpal"!==t?.namespace)return t;switch(t.type){case"SYN":return e("React Native: Converting SYN to deprecated format to avoid MessagePorts",{originalMessage:t}),{penpal:"syn",participantId:t.participantId};case"ACK1":return e("React Native: Converting ACK1 to deprecated format",{originalMessage:t}),{penpal:"synAck",methodNames:t.methodPaths||[]};case"ACK2":return e("React Native: Converting ACK2 to deprecated format",{originalMessage:t}),{penpal:"ack"};case"REPLY":{e("React Native: Converting REPLY to deprecated format",{originalMessage:t});const s=this.getNumericId(t.callId);return t.isError?{penpal:"reply",id:s,resolution:"rejected",returnValue:t.value,returnValueIsError:t.isSerializedErrorInstance||!1}:{penpal:"reply",id:s,resolution:"fulfilled",returnValue:t.value}}case"CALL":e("React Native: Converting CALL to deprecated format",{originalMessage:t});return{penpal:"call",id:this.getNumericId(t.id),methodName:t.methodPath.join("."),args:t.args};case"DESTROY":return{namespace:"penpal",type:"DESTROY"};default:return t}}convertFromDeprecatedFormat(t){if(t?.penpal)switch(t.penpal){case"syn":{e("[HANDSHAKE DEBUG] React Native: Converting deprecated SYN to modern format",{originalMessage:t});const s={namespace:"penpal",type:"SYN",participantId:t.participantId};return e("[HANDSHAKE DEBUG] Converted SYN:",s),s}case"synAck":{e("[HANDSHAKE DEBUG] React Native: Converting deprecated synAck to modern ACK1 format",{originalMessage:t});const s={namespace:"penpal",type:"ACK1",methodPaths:t.methodNames?.map(e=>e.split("."))||[],channel:void 0};return e("[HANDSHAKE DEBUG] Converted ACK1:",s),s}case"ack":{e("[HANDSHAKE DEBUG] React Native: Converting deprecated ack to modern ACK2 format",{originalMessage:t});const s={namespace:"penpal",type:"ACK2",channel:void 0};return e("[HANDSHAKE DEBUG] Converted ACK2:",s),s}case"reply":{e("React Native: Converting deprecated reply to modern REPLY format",{originalMessage:t});const s=this.getStringId(t.id);s||e(`Warning: No string ID mapping found for numeric ID ${t.id}, using as-is`);const a=s||String(t.id);return"fulfilled"===t.resolution?{namespace:"penpal",type:"REPLY",callId:a,value:t.returnValue}:{namespace:"penpal",type:"REPLY",callId:a,isError:!0,value:t.returnValue,isSerializedErrorInstance:t.returnValueIsError||!1}}case"call":{e("React Native: Converting deprecated call to modern CALL format",{originalMessage:t});const s=this.getStringId(t.id);return s||e(`Warning: No string ID mapping found for numeric ID ${t.id}, using as-is`),{namespace:"penpal",type:"CALL",id:s||String(t.id),methodPath:t.methodName.split("."),args:t.args}}default:return e("React Native: Unknown deprecated penpal message type:",t.penpal),t}return t}setupMessagePort(t){e("React Native: setupMessagePort called but ignored (MessagePort not supported)")}destroy(){this.isInitialized&&(this.handlers.clear(),this.messageBuffer=[],this.stringToNumericId.clear(),this.numericToStringId.clear(),this.nextNumericId=1,this.isInitialized=!1,this.hasBeenUsed=!1,e("ReactNativeMessenger destroyed and ready for reuse"))}reset(){e("ReactNativeMessenger reset for reuse"),this.handlers.clear(),this.messageBuffer=[],this.isInitialized=!1,this.hasBeenUsed=!1,this.nextNumericId=1,this.stringToNumericId.clear(),this.numericToStringId.clear()}getNumericId(t){let s=this.stringToNumericId.get(t);return s||(s=this.nextNumericId++,this.stringToNumericId.set(t,s),this.numericToStringId.set(s,t),e(`ID mapping created: "${t}" -> ${s}`)),s}getStringId(e){return this.numericToStringId.get(e)}}export{s as ReactNativeMessenger};
