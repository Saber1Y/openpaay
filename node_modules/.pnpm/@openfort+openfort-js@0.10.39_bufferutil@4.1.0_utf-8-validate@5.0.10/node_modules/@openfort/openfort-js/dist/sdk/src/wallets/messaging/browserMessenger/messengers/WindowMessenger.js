import{downgradeMessage as e,isDeprecatedMessage as s,upgradeMessage as t}from"../backwardCompatibility.js";import{isSynMessage as i,isAck1Message as o,isAck2Message as r}from"../guards.js";import n from"../PenpalBugError.js";import a from"../PenpalError.js";class d{#e;#s;#t;#i;#o;#r=new Set;#n;#a=!1;constructor({remoteWindow:e,allowedOrigins:s}){if(!e)throw new a("INVALID_ARGUMENT","remoteWindow must be defined");this.#e=e,this.#s=s?.length?s:[window.origin]}initialize=({log:e,validateReceivedMessage:s})=>{this.#t=e,this.#i=s,window.addEventListener("message",this.#d)};sendMessage=(s,t)=>{if(i(s)){const e=this.#g(s);return void this.#e.postMessage(s,{targetOrigin:e,transfer:t})}if(o(s)||this.#a){const i=this.#a?e(s):s,o=this.#g(s);return void this.#e.postMessage(i,{targetOrigin:o,transfer:t})}if(r(s)){const{port1:e,port2:i}=new MessageChannel;this.#n=e,e.addEventListener("message",this.#l),e.start();const o=[i,...t||[]],r=this.#g(s);return void this.#e.postMessage(s,{targetOrigin:r,transfer:o})}if(!this.#n)throw new n("Port is undefined");this.#n.postMessage(s,{transfer:t})};addMessageHandler=e=>{this.#r.add(e)};removeMessageHandler=e=>{this.#r.delete(e)};destroy=()=>{window.removeEventListener("message",this.#d),this.#h(),this.#r.clear()};#c=e=>this.#s.some(s=>s instanceof RegExp?s.test(e):s===e||"*"===s);#g=e=>{if(i(e))return"*";if(!this.#o)throw new n("Concrete remote origin not set");return"null"===this.#o&&this.#s.includes("*")?"*":this.#o};#h=()=>{this.#n?.removeEventListener("message",this.#l),this.#n?.close(),this.#n=void 0};#d=({source:e,origin:o,ports:a,data:d})=>{if(e===this.#e&&(s(d)&&(this.#t?.("Please upgrade the child window to the latest version of Penpal."),this.#a=!0,d=t(d)),this.#i?.(d)))if(this.#c(o)){if(i(d)&&(this.#h(),this.#o=o),r(d)&&!this.#a){if([this.#n]=a,!this.#n)throw new n("No port received on ACK2");this.#n.addEventListener("message",this.#l),this.#n.start()}for(const e of this.#r)e(d)}else this.#t?.(`Received a message from origin \`${o}\` which did not match allowed origins \`[${this.#s.join(", ")}]\``)};#l=({data:e})=>{if(this.#i?.(e))for(const s of this.#r)s(e)}}export{d as default};
