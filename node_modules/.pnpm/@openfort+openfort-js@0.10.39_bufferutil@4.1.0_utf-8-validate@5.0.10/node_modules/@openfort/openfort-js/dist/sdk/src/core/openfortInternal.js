import{debugLog as t}from"../utils/debug.js";import{singlePromise as e}from"../utils/promiseUtils.js";import{TokenType as r,OpenfortEvents as a}from"../types/types.js";import{SDKConfiguration as o}from"./config/config.js";import{Authentication as i}from"./configuration/authentication.js";import{OpenfortError as n,OpenfortErrorType as s}from"./errors/openfortError.js";class h{storage;authManager;eventEmitter;constructor(t,e,r){this.storage=t,this.authManager=e,this.eventEmitter=r}async getThirdPartyAuthToken(){const t=o.getInstance();if(!t?.thirdPartyAuth)throw new n("No third party configuration found",s.INTERNAL_ERROR);const{getAccessToken:e,provider:a}=t.thirdPartyAuth;if(!e||!a)throw new n("Third party is not configured. Please configure getAccessToken and thirdPartyAuthProvider in your Openfort instance",s.INVALID_CONFIGURATION);const h=await e();if(!h)throw new n("Could not get access token",s.AUTHENTICATION_ERROR);let c=(await i.fromStorage(this.storage))?.player;if(!c){const t=await this.authManager.authenticateThirdParty(a,h,r.ID_TOKEN);c=t?.id}return new i("third_party",h,c,null,a,r.ID_TOKEN).save(this.storage),h}async getAccessToken(){if(o.getInstance()?.thirdPartyAuth)return this.getThirdPartyAuthToken();return(await i.fromStorage(this.storage))?.token??null}async validateAndRefreshToken(r){return e(async()=>{if(o.getInstance()?.thirdPartyAuth)return void await this.getThirdPartyAuthToken();const e=await i.fromStorage(this.storage);if(!e)throw new n("Must be logged in to validate and refresh token",s.NOT_LOGGED_IN_ERROR);let h;t("validating credentials...");try{h=await this.authManager.validateCredentials(e,r)}catch(t){throw i.clear(this.storage),this.eventEmitter.emit(a.ON_LOGOUT),t}if(!h.player)throw new n("No user found in credentials",s.INTERNAL_ERROR);h.accessToken!==e.token&&(t("tokens refreshed"),new i("jwt",h.accessToken,h.player,h.refreshToken).save(this.storage))},"openfort.validateAndRefreshToken")}}export{h as OpenfortInternal};
